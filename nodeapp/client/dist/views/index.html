<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Google Map</title>
  <style>
    #map {
      height: 100%;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5o8ZVhKL3LGzQabrtcnU0zb2SOx9WR3o">
  </script>
  <script src="https://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js"></script>
</head>

<body>
  <div id="map"></div>
  <script>
    function initMap(markers) {
      var map = new google.maps.Map(document.getElementById('map'), {
        mapTypeId: google.maps.MapTypeId.roadmap
      });
      var bounds = new google.maps.LatLngBounds();
      var infoWindow = new google.maps.InfoWindow();
      var oms = new OverlappingMarkerSpiderfier(map, {
        markersWontMove: true,
        markersWontHide: true,
        keepSpiderfied: true
      });
      function createMarker(markerData, i) {
        var position = new google.maps.LatLng({
          lat: parseFloat(markerData.coordinate.lat),
          lng: parseFloat(markerData.coordinate.lng)
        });
        bounds.extend(position);
        var marker = new google.maps.Marker({
          position: position,
          map: map,
          label: (i + 1).toString()
        });
        google.maps.event.addListener(marker, "click", function () {
          infoWindow.setContent("<b>Marker: " + marker.label +
            "<br/>Time: " + new Date(markerData.time) + "</b><br/>" + JSON.stringify(markerData));
          infoWindow.open(map, marker);
        });
        oms.addMarker(marker);
        map.fitBounds(bounds);
      }
      for (var i = 0; i < markers.length; i++) {
        createMarker(markers[i], i);
      }
    }

    fetch('/getCheckin').then(function (response) {
      var contentType = response.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        return response.json();
      }
      throw new TypeError("Oops, we haven't got JSON!");
    })
      .then(function (json) {
        console.log(json);
        var documents = json.data.filter(function (checkin) {
          if (checkin.checkinData.location.coordinate &&
            checkin.checkinData.location.coordinate.lat) {
            return true;
          }
        }).map(function (checkin) {
          return {
            type: checkin.checkinData.location.type,
            coordinate: checkin.checkinData.location.coordinate,
            time: parseInt(checkin.checkinData.submittedOn)
          }
        });
        console.log(documents);
        initMap(documents);
      })
      .catch(function (error) { console.log(error); });
  </script>
</body>

</html>